<!DOCTYPE html><html><head><meta charset="utf-8"><title>Spotify Redirect</title></head>
<body><p>認証処理中…</p>
<script>
const params = new URLSearchParams(location.search);
const code = params.get('code');
const verifier = localStorage.getItem('spotify_pkce_verifier');
const CLIENT_ID = "9892d015f2734e85a98e291efff7396d";
const REDIRECT_URI = "https://a-tune712.github.io/Spotify--redirect/";

async function exchange() {
  if (!code || !verifier) {
    document.body.innerHTML = "<p>code または verifier がありません。</p>";
    return;
  }
  const body = new URLSearchParams({
    grant_type: "authorization_code",
    code,
    redirect_uri: REDIRECT_URI,
    client_id: CLIENT_ID,
    code_verifier: verifier
  });

  const res = await fetch("https://accounts.spotify.com/api/token", {
    method: "POST",
    headers: {"Content-Type": "application/x-www-form-urlencoded"},
    body
  });

  if (!res.ok) {
    const t = await res.text();
    document.body.innerHTML = "<pre>トークン交換エラー:\n" + res.status + "\n" + t + "</pre>";
    return;
  }

  const json = await res.json();
  const token = json.access_token;
  const expiresIn = json.expires_in || 3600;
  const expireAt = Date.now() + expiresIn*1000;

  localStorage.setItem("spotify_access_token", token);
  localStorage.setItem("spotify_token_expire_at", String(expireAt));

  // 再生ページへ
  location.replace("https://a-tune712.github.io/Spotify-A/");
}

exchange();
</script>
</body></html>
